{"version":3,"sources":["../src/prepare-bundle.js"],"names":["copy","source","destination","vars","contents","fs","readFileSync","toString","ejs","render","writeFileSync","injectFiles","api","name","version","appConfig","yumPackages","forceSSL","gracefulShutdown","buildOptions","longEnvVars","bundlePath","buildLocation","app","bucket","sourcePath","resolvePath","__dirname","destPath","mkdirSync","e","code","console","log","nodeVersion","npmVersion","packages","bucketName","archiveApp","unlinkSync","Promise","resolve","reject","sourceDir","output","createWriteStream","archive","gzip","gzipOptions","level","pipe","once","err","message","nextProgress","on","entries","progress","processed","total","Math","floor","directory","finalize"],"mappings":"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","sourcesContent":["import archiver from 'archiver';\nimport fs from 'fs';\nimport ejs from 'ejs';\nimport { round } from 'lodash';\nimport { getNodeVersion, logStep, names } from './utils';\n\nfunction copy(source, destination, vars = {}) {\n  let contents = fs.readFileSync(source).toString();\n\n  contents = ejs.render(contents, vars);\n\n  fs.writeFileSync(destination, contents);\n}\n\nexport function injectFiles(api, name, version, appConfig) {\n  const {\n    yumPackages,\n    forceSSL,\n    gracefulShutdown,\n    buildOptions,\n    longEnvVars\n  } = appConfig;\n  const bundlePath = buildOptions.buildLocation;\n  const {\n    bucket\n  } = names({ app: appConfig });\n\n  let sourcePath = api.resolvePath(__dirname, './assets/package.json');\n  let destPath = api.resolvePath(bundlePath, 'bundle/package.json');\n  copy(sourcePath, destPath, {\n    name,\n    version\n  });\n\n  sourcePath = api.resolvePath(__dirname, './assets/npmrc');\n  destPath = api.resolvePath(bundlePath, 'bundle/.npmrc');\n  copy(sourcePath, destPath);\n\n  sourcePath = api.resolvePath(__dirname, './assets/start.sh');\n  destPath = api.resolvePath(bundlePath, 'bundle/start.sh');\n  copy(sourcePath, destPath);\n\n  try {\n    fs.mkdirSync(api.resolvePath(bundlePath, 'bundle/.ebextensions'));\n  } catch (e) {\n    if (e.code !== 'EEXIST') {\n      console.log(e);\n    }\n  }\n\n  const { nodeVersion, npmVersion } = getNodeVersion(api, bundlePath);\n  sourcePath = api.resolvePath(__dirname, './assets/node.yaml');\n  destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/node.config');\n  copy(sourcePath, destPath, { nodeVersion, npmVersion });\n\n  sourcePath = api.resolvePath(__dirname, './assets/nginx.yaml');\n  destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/nginx.config');\n  copy(sourcePath, destPath, { forceSSL });\n\n  if (yumPackages) {\n    sourcePath = api.resolvePath(__dirname, './assets/packages.yaml');\n    destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/packages.config');\n    copy(sourcePath, destPath, { packages: yumPackages });\n  }\n\n  if (gracefulShutdown) {\n    sourcePath = api.resolvePath(__dirname, './assets/graceful_shutdown.yaml');\n    destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/graceful_shutdown.config');\n    copy(sourcePath, destPath);\n  }\n\n  if (longEnvVars) {\n    sourcePath = api.resolvePath(__dirname, './assets/env.yaml');\n    destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/env.config');\n    copy(sourcePath, destPath, {\n      bucketName: bucket\n    });\n  }\n\n  sourcePath = api.resolvePath(__dirname, './assets/health-check.js');\n  destPath = api.resolvePath(bundlePath, 'bundle/health-check.js');\n  copy(sourcePath, destPath);\n}\n\nexport function archiveApp(buildLocation, api) {\n  const bundlePath = api.resolvePath(buildLocation, 'bundle.zip');\n\n  try {\n    fs.unlinkSync(bundlePath);\n  } catch (e) {\n    // empty\n  }\n\n  return new Promise((resolve, reject) => {\n    logStep('=> Archiving Bundle');\n    const sourceDir = api.resolvePath(buildLocation, 'bundle');\n\n    const output = fs.createWriteStream(bundlePath);\n    const archive = archiver('zip', {\n      gzip: true,\n      gzipOptions: {\n        level: 9\n      }\n    });\n\n    archive.pipe(output);\n    output.once('close', resolve);\n\n    archive.once('error', (err) => {\n      logStep('=> Archiving failed:', err.message);\n      reject(err);\n    });\n\n    let nextProgress = 0.1;\n    archive.on('progress', ({ entries }) => {\n      try {\n        const progress = entries.processed / entries.total;\n\n        if (progress > nextProgress) {\n          console.log(`  ${round(Math.floor(nextProgress * 100), -1)}% Archived`);\n          nextProgress += 0.1;\n        }\n      } catch (e) {\n        console.log(e);\n      }\n    });\n\n    archive.directory(sourceDir, false).finalize();\n  });\n}\n"],"file":"prepare-bundle.js"}