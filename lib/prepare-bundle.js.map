{"version":3,"sources":["../src/prepare-bundle.js"],"names":["archiver","fs","ejs","round","getNodeVersion","logStep","names","copy","source","destination","vars","contents","readFileSync","toString","render","writeFileSync","injectFiles","api","name","version","appConfig","yumPackages","forceSSL","gracefulShutdown","buildOptions","longEnvVars","bundlePath","buildLocation","bucket","app","sourcePath","resolvePath","__dirname","destPath","mkdirSync","e","code","console","log","nodeVersion","npmVersion","packages","bucketName","archiveApp","unlinkSync","Promise","resolve","reject","sourceDir","output","createWriteStream","archive","gzip","gzipOptions","level","pipe","once","err","message","nextProgress","on","entries","progress","processed","total","Math","floor","directory","finalize"],"mappings":"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","sourcesContent":["import archiver from 'archiver';\nimport fs from 'fs';\nimport ejs from 'ejs';\nimport { round } from 'lodash';\nimport { getNodeVersion, logStep, names } from './utils';\n\nfunction copy(source, destination, vars = {}) {\n  let contents = fs.readFileSync(source).toString();\n\n  contents = ejs.render(contents, vars);\n\n  fs.writeFileSync(destination, contents);\n}\n\nexport function injectFiles(api, name, version, appConfig) {\n  const {\n    yumPackages,\n    forceSSL,\n    gracefulShutdown,\n    buildOptions,\n    longEnvVars\n  } = appConfig;\n  const bundlePath = buildOptions.buildLocation;\n  const {\n    bucket\n  } = names({ app: appConfig });\n\n  let sourcePath = api.resolvePath(__dirname, './assets/package.json');\n  let destPath = api.resolvePath(bundlePath, 'bundle/package.json');\n  copy(sourcePath, destPath, {\n    name,\n    version\n  });\n\n  sourcePath = api.resolvePath(__dirname, './assets/npmrc');\n  destPath = api.resolvePath(bundlePath, 'bundle/.npmrc');\n  copy(sourcePath, destPath);\n\n  sourcePath = api.resolvePath(__dirname, './assets/start.sh');\n  destPath = api.resolvePath(bundlePath, 'bundle/start.sh');\n  copy(sourcePath, destPath);\n\n  try {\n    fs.mkdirSync(api.resolvePath(bundlePath, 'bundle/.ebextensions'));\n  } catch (e) {\n    if (e.code !== 'EEXIST') {\n      console.log(e);\n    }\n  }\n\n  const { nodeVersion, npmVersion } = getNodeVersion(api, bundlePath);\n  sourcePath = api.resolvePath(__dirname, './assets/node.yaml');\n  destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/node.config');\n  copy(sourcePath, destPath, { nodeVersion, npmVersion });\n\n  sourcePath = api.resolvePath(__dirname, './assets/nginx.yaml');\n  destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/nginx.config');\n  copy(sourcePath, destPath, { forceSSL });\n\n  if (yumPackages) {\n    sourcePath = api.resolvePath(__dirname, './assets/packages.yaml');\n    destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/packages.config');\n    copy(sourcePath, destPath, { packages: yumPackages });\n  }\n\n  if (gracefulShutdown) {\n    sourcePath = api.resolvePath(__dirname, './assets/graceful_shutdown.yaml');\n    destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/graceful_shutdown.config');\n    copy(sourcePath, destPath);\n  }\n\n  if (longEnvVars) {\n    sourcePath = api.resolvePath(__dirname, './assets/env.yaml');\n    destPath = api.resolvePath(bundlePath, 'bundle/.ebextensions/env.config');\n    copy(sourcePath, destPath, {\n      bucketName: bucket\n    });\n  }\n\n  sourcePath = api.resolvePath(__dirname, './assets/health-check.js');\n  destPath = api.resolvePath(bundlePath, 'bundle/health-check.js');\n  copy(sourcePath, destPath);\n}\n\nexport function archiveApp(buildLocation, api) {\n  const bundlePath = api.resolvePath(buildLocation, 'bundle.zip');\n\n  try {\n    fs.unlinkSync(bundlePath);\n  } catch (e) {\n    // empty\n  }\n\n  return new Promise((resolve, reject) => {\n    logStep('=> Archiving Bundle');\n    const sourceDir = api.resolvePath(buildLocation, 'bundle');\n\n    const output = fs.createWriteStream(bundlePath);\n    const archive = archiver('zip', {\n      gzip: true,\n      gzipOptions: {\n        level: 9\n      }\n    });\n\n    archive.pipe(output);\n    output.once('close', resolve);\n\n    archive.once('error', (err) => {\n      logStep('=> Archiving failed:', err.message);\n      reject(err);\n    });\n\n    let nextProgress = 0.1;\n    archive.on('progress', ({ entries }) => {\n      try {\n        const progress = entries.processed / entries.total;\n\n        if (progress > nextProgress) {\n          console.log(`  ${round(Math.floor(nextProgress * 100), -1)}% Archived`);\n          nextProgress += 0.1;\n        }\n      } catch (e) {\n        console.log(e);\n      }\n    });\n\n    archive.directory(sourceDir, false).finalize();\n  });\n}\n"],"file":"prepare-bundle.js"}