{"version":3,"sources":["../src/upload.js"],"names":["upload","appConfig","bucket","key","bundlePath","params","Bucket","fileStream","fs","createReadStream","on","err","console","log","Body","Key","Promise","resolve","reject","lastPercentage","uploader","s3","progress","percentage","Math","floor","loaded","total","send","result","uploadEnvFile","version","env","settings","content","settingsString","encodeURIComponent","JSON","stringify","Object","keys","forEach","value"],"mappings":";;;;;;;;;;AAAA;;AACA;;AACA;;AAEe,SAASA,MAAT,CAAgBC,SAAhB,EAA2BC,MAA3B,EAAmCC,GAAnC,EAAwCC,UAAxC,EAAoD;AACjE,MAAMC,MAAM,GAAG;AAAEC,IAAAA,MAAM,EAAEJ;AAAV,GAAf;;AACA,MAAMK,UAAU,GAAGC,YAAGC,gBAAH,CAAoBL,UAApB,CAAnB;;AACAG,EAAAA,UAAU,CAACG,EAAX,CAAc,OAAd,EAAuB,UAACC,GAAD,EAAS;AAC9BC,IAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;AACD,GAFD;AAIAN,EAAAA,MAAM,CAACS,IAAP,GAAcP,UAAd;AACAF,EAAAA,MAAM,CAACU,GAAP,GAAaZ,GAAb;AAEA,SAAO,IAAIa,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,QAAIC,cAAc,GAAG,CAAC,CAAtB;;AAEA,QAAMC,QAAQ,GAAGC,QAAGrB,MAAH,CAAUK,MAAV,CAAjB;;AAEAe,IAAAA,QAAQ,CAACV,EAAT,CAAY,oBAAZ,EAAkC,UAACY,QAAD,EAAc;AAC9C,UAAMC,UAAU,GAAGC,IAAI,CAACC,KAAL,CAAWH,QAAQ,CAACI,MAAT,GAAkBJ,QAAQ,CAACK,KAA3B,GAAmC,GAA9C,CAAnB;;AAEA,UAAIJ,UAAU,KAAKJ,cAAnB,EAAmC;AACjCP,QAAAA,OAAO,CAACC,GAAR,sBAA0BU,UAA1B;;AAEA,YAAIA,UAAU,KAAK,GAAnB,EAAwB;AACtBX,UAAAA,OAAO,CAACC,GAAR,CAAY,sDAAZ;AACD;AACF;;AAEDM,MAAAA,cAAc,GAAGI,UAAjB;AACD,KAZD;AAcAH,IAAAA,QAAQ,CAACQ,IAAT,CAAc,UAACjB,GAAD,EAAMkB,MAAN,EAAiB;AAC7B,UAAIlB,GAAJ,EAAS;AACPO,QAAAA,MAAM,CAACP,GAAD,CAAN;AACA;AACD;;AAEDM,MAAAA,OAAO,CAACY,MAAD,CAAP;AACD,KAPD;AAQD,GA3BM,CAAP;AA4BD;;AAEM,SAASC,aAAT,CAAuB5B,MAAvB,EAA+B6B,OAA/B,EAAwCC,GAAxC,EAA6CC,QAA7C,EAAuD;AAC5D,MAAIC,OAAO,GAAG,EAAd;AACA,MAAMC,cAAc,GAAGC,kBAAkB,CAACC,IAAI,CAACC,SAAL,CAAeL,QAAf,CAAD,CAAzC;AAEAM,EAAAA,MAAM,CAACC,IAAP,CAAYR,GAAZ,EAAiBS,OAAjB,CAAyB,UAACtC,GAAD,EAAS;AAChC,QAAMuC,KAAK,GAAG,0BAAY,CAACV,GAAG,CAAC7B,GAAD,CAAJ,CAAZ,CAAd;AACA+B,IAAAA,OAAO,qBAAc/B,GAAd,cAAqBuC,KAArB,OAAP;AACD,GAHD;AAKAR,EAAAA,OAAO,6CAAsC,0BAAY,CAACC,cAAD,CAAZ,CAAtC,CAAP;AAEA,SAAO,IAAInB,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,QAAME,QAAQ,GAAGC,QAAGrB,MAAH,CAAU;AACzBM,MAAAA,MAAM,EAAEJ,MADiB;AAEzBY,MAAAA,IAAI,EAAEoB,OAFmB;AAGzBnB,MAAAA,GAAG,gBAASgB,OAAT;AAHsB,KAAV,CAAjB;;AAKAX,IAAAA,QAAQ,CAACQ,IAAT,CAAc,UAACjB,GAAD,EAAMkB,MAAN,EAAiB;AAC7B,UAAIlB,GAAJ,EAAS;AACP,eAAOO,MAAM,CAACP,GAAD,CAAb;AACD;;AAEDM,MAAAA,OAAO,CAACY,MAAD,CAAP;AACD,KAND;AAOD,GAbM,CAAP;AAcD","sourcesContent":["import fs from 'fs';\nimport shellEscape from 'shell-escape';\nimport { s3 } from './aws';\n\nexport default function upload(appConfig, bucket, key, bundlePath) {\n  const params = { Bucket: bucket };\n  const fileStream = fs.createReadStream(bundlePath);\n  fileStream.on('error', (err) => {\n    console.log(err);\n  });\n\n  params.Body = fileStream;\n  params.Key = key;\n\n  return new Promise((resolve, reject) => {\n    let lastPercentage = -1;\n\n    const uploader = s3.upload(params);\n\n    uploader.on('httpUploadProgress', (progress) => {\n      const percentage = Math.floor(progress.loaded / progress.total * 100);\n\n      if (percentage !== lastPercentage) {\n        console.log(`  Uploaded ${percentage}%`);\n\n        if (percentage === 100) {\n          console.log('  Finishing upload. This could take a couple minutes');\n        }\n      }\n\n      lastPercentage = percentage;\n    });\n\n    uploader.send((err, result) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n\n      resolve(result);\n    });\n  });\n}\n\nexport function uploadEnvFile(bucket, version, env, settings) {\n  let content = '';\n  const settingsString = encodeURIComponent(JSON.stringify(settings));\n\n  Object.keys(env).forEach((key) => {\n    const value = shellEscape([env[key]]);\n    content += `export ${key}=${value}\\n`;\n  });\n\n  content += `export METEOR_SETTINGS_ENCODED=${shellEscape([settingsString])}`;\n\n  return new Promise((resolve, reject) => {\n    const uploader = s3.upload({\n      Bucket: bucket,\n      Body: content,\n      Key: `env/${version}.txt`\n    });\n    uploader.send((err, result) => {\n      if (err) {\n        return reject(err);\n      }\n\n      resolve(result);\n    });\n  });\n}\n"],"file":"upload.js"}